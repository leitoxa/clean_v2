
// –°–ª—É–∂–±–∞
public class CleanupService : ServiceBase
{
    private System.Threading.Timer timer;

    public CleanupService()
    {
        this.ServiceName = "FileCleanupService";
    }

    protected override void OnStart(string[] args)
    {
        try
        {
            Program.Log("–°–ª—É–∂–±–∞ –∑–∞–ø—É—â–µ–Ω–∞", "SERVICE");
            Program.LoadConfig();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ - —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–∞–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
            if (Program.Config.Folders == null || Program.Config.Folders.Count == 0)
            {
                Program.Log("–û–®–ò–ë–ö–ê: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –ø–∞–ø–∫–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏!", "ERROR");
                throw new Exception("–ü–∞–ø–∫–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–∞–ø–∫–∏.");
            }
            
            int enabledCount = Program.Config.Folders.Count(f => f.Enabled && !string.IsNullOrEmpty(f.FolderPath));
            if (enabledCount == 0)
            {
                Program.Log("–û–®–ò–ë–ö–ê: –ù–µ—Ç –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏!", "ERROR");
                throw new Exception("–í–∫–ª—é—á–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–∞–ø–∫—É –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.");
            }
            
            Program.Log(string.Format("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞: {0} –ø–∞–ø–æ–∫, {1} –≤–∫–ª—é—á–µ–Ω–æ", 
                Program.Config.Folders.Count, enabledCount), "INFO");
            
            try
            {
                Program.SendTelegramNotification(string.Format("‚úÖ –°–ª—É–∂–±–∞ File Cleanup Service –∑–∞–ø—É—â–µ–Ω–∞\nüìÅ –ü–∞–ø–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ: {0}\n‚úì –í–∫–ª—é—á–µ–Ω–æ: {1}", 
                    Program.Config.Folders.Count, enabledCount));
            }
            catch (Exception ex)
            {
                Program.Log("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: " + ex.Message, "WARN");
            }
            
            int interval = Program.Config.IntervalMinutes * 60 * 1000;
            if (interval <= 0) interval = 3600000;

            timer = new System.Threading.Timer(DoCleanup, null, 0, interval);
            Program.Log("–°–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞, –∏–Ω—Ç–µ—Ä–≤–∞–ª: " + interval + "–º—Å", "INFO");
        }
        catch (Exception ex)
        {
            Program.Log("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–±—ã: " + ex.ToString(), "ERROR");
            throw;
        }
    }

    protected override void OnStop()
    {
        try
        {
            Program.Log("–°–ª—É–∂–±–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", "SERVICE");
            try
            {
                Program.SendTelegramNotification("üõë –°–ª—É–∂–±–∞ File Cleanup Service –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
            }
            catch (Exception ex)
            {
                Program.Log("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: " + ex.Message, "WARN");
            }
            if (timer != null) timer.Dispose();
        }
        catch (Exception ex)
        {
            Program.Log("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª—É–∂–±—ã: " + ex.ToString(), "ERROR");
        }
    }

    private void DoCleanup(object state)
    {
        Program.LoadConfig();
        Cleaner.RunCleanupAll();
    }
}

// –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Å–ª—É–∂–±—ã
[RunInstaller(true)]
public class MyServiceInstaller : Installer
{
    public MyServiceInstaller()
    {
        var processInstaller = new ServiceProcessInstaller();
        var serviceInstaller = new ServiceInstaller();

        processInstaller.Account = ServiceAccount.LocalSystem;

        serviceInstaller.DisplayName = "File Cleanup Manager";
        serviceInstaller.StartType = ServiceStartMode.Automatic;
        serviceInstaller.ServiceName = "FileCleanupService";
        serviceInstaller.Description = "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞–ø–æ–∫";

        Installers.Add(processInstaller);
        Installers.Add(serviceInstaller);
    }
}

// –û—á–∏—Å—Ç–∫–∞
public static class Cleaner
{
    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫
    public static void RunCleanupAll()
    {
        if (Program.Config.Folders == null || Program.Config.Folders.Count == 0)
        {
            Program.Log("–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏", "WARN");
            return;
        }

        int totalDeleted = 0;
        var results = new List<string>();

        foreach (var folder in Program.Config.Folders)
        {
            if (!folder.Enabled)
            {
                Program.Log(string.Format("–ü–∞–ø–∫–∞ '{0}' –æ—Ç–∫–ª—é—á–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º", folder.TabName), "INFO");
                continue;
            }

            int deleted = RunCleanup(folder);
            totalDeleted += deleted;
            
            if (deleted > 0)
            {
                results.Add(string.Format("üìÇ *{0}*: {1} —Ñ–∞–π–ª–æ–≤", folder.TabName, deleted));
            }
        }

        if (totalDeleted > 0 && results.Count > 0)
        {
            string msg = "üßπ *–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞*\n\n" + string.Join("\n", results.ToArray()) + 
                         "\n\nüóë *–í—Å–µ–≥–æ —É–¥–∞–ª–µ–Ω–æ: " + totalDeleted + "*";
            try
            {
                Program.SendTelegramNotification(msg);
            }
            catch (Exception ex)
            {
                Program.Log("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: " + ex.Message, "WARN");
            }
        }
    }

    // –û—á–∏—Å—Ç–∫–∞ –æ–¥–Ω–æ–π –ø–∞–ø–∫–∏
    public static int RunCleanup(FolderConfig folder)
    {
        if (string.IsNullOrEmpty(folder.FolderPath) || !Directory.Exists(folder.FolderPath))
        {
            Program.Log(string.Format("–ü–∞–ø–∫–∞ '{0}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {1}", folder.TabName, folder.FolderPath), "WARN");
            return 0;
        }

        Program.Log(string.Format("–ù–∞—á–∞–ª–æ –æ—á–∏—Å—Ç–∫–∏ '{0}': {1}", folder.TabName, folder.FolderPath), "INFO");
        int deletedCount = 0;
        DateTime threshold = DateTime.Now.AddDays(-folder.DaysOld);

        try
        {
            System.IO.SearchOption searchOption = folder.Recursive ? System.IO.SearchOption.AllDirectories : System.IO.SearchOption.TopDirectoryOnly;
            var files = Directory.GetFiles(folder.FolderPath, "*.*", searchOption);

            foreach (var file in files)
            {
                try
                {
                    if (Program.Config.DetailedLog) Program.Log("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞: " + file, "DEBUG");

                    // –§–∏–ª—å—Ç—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
                    if (folder.FileExtensions != null && folder.FileExtensions.Count > 0)
                    {
                        string ext = Path.GetExtension(file).ToLower();
                        if (!folder.FileExtensions.Contains(ext)) 
                        {
                            if (Program.Config.DetailedLog) Program.Log("–ü—Ä–æ–ø—É—Å–∫ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ): " + file, "DEBUG");
                            continue;
                        }
                    }

                    DateTime lastWriteTime = File.GetLastWriteTime(file);
                    if (lastWriteTime < threshold)
                    {
                        if (folder.UseRecycleBin)
                        {
                             FileSystem.DeleteFile(file, UIOption.OnlyErrorDialogs, RecycleOption.SendToRecycleBin);
                        }
                        else
                        {
                            File.Delete(file);
                        }
                        
                        deletedCount++;
                        Program.Log(string.Format("–£–¥–∞–ª–µ–Ω —Ñ–∞–π–ª: {0}", file), "INFO");
                    }
                    else
                    {
                        if (Program.Config.DetailedLog) Program.Log("–ü—Ä–æ–ø—É—Å–∫ (—Å–ª–∏—à–∫–æ–º –Ω–æ–≤—ã–π): " + file, "DEBUG");
                    }
                }
                catch (Exception ex)
                {
                    Program.Log(string.Format("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ {0}: {1}", file, ex.Message), "ERROR");
                }
            }
        }
        catch (Exception ex)
        {
            Program.Log(string.Format("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è '{0}': {1}", folder.TabName, ex.Message), "ERROR");
        }

        Program.Log(string.Format("–û—á–∏—Å—Ç–∫–∞ '{0}' –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£–¥–∞–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {1}", folder.TabName, deletedCount), "INFO");
        return deletedCount;
    }
}
